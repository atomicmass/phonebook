<!DOCTYPE html>
<html>

<head>
    <title>Phonebook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.9.0.js"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/knockout/knockout-2.2.1.js"></script>
</head>

<body>
    <div id="nav" class="navbar">
        <div class="navbar-inner">
            <a class="brand" href="#">Phonebook</a>
            <span data-bind="visible: !authenticated()">
                <button data-bind="click: showRegister" class="btn">Register</button>
                <button data-bind="click: showLogin" class="btn">Login</button>
            </span>
            <span data-bind="visible: authenticated()">
                <button data-bind="click: logout" class="btn">Logout</button>
            </span>
        </div>

    </div>

    <div id="message" class="hide alert alert-error" role="alert">
        <p data-bind="text: warning"></p>
    </div>

    <div id="main" class="container">
        <p>
            Welcome to the phonebook application. Register or login to proceeed.
        </p>

    </div>

    <div id="phonebook" class="hide container">
        <button data-bind="click: showContact" class="btn">Add Contact</button>
    </div>

    <div id="register" class="modal hide fade" tabindex="1" role="dialog" aria-labelledby="registerDialogLabel"
        aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="registerDialogLabel">Register new user</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputName">Name</label>
                    <div class="controls">
                        <input data-bind="value: name" type="text" id="inputName" placeholder="Name" autocomplete="name"
                            style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputEmail">Email</label>
                    <div class="controls">
                        <input data-bind="value: email" type="text" id="inputEmail" autocomplete="email"
                            placeholder="Email" style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputPassword">Password</label>
                    <div class="controls">
                        <input data-bind="value: password" type="password" id="inputPassword"
                            autocomplete="new-password" placeholder="Password" style="width: 150px;">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: register" class="btn btn-primary">Register</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        </div>
    </div>

    <div id="login" class="modal hide fade" tabindex="1" role="dialog" aria-labelledby="loginLabel" aria-hidden="true">
        <div class="modal-header">
            <h3 id="loginLabel">Sign In</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputLoginEmail">Email</label>
                    <div class="controls">
                        <input data-bind="value: email" type="text" id="inputLoginEmail" placeholder="Email"
                            autocomplete="email">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputLoginPassword">Password</label>
                    <div class="controls">
                        <input data-bind="value: password" type="password" id="inputLoginPassword"
                            placeholder="Password" autocomplete="current-password">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: login" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Sign
                In</button>
        </div>
    </div>
    
    
    <div id="contact" class="modal hide fade" tabindex="1" role="dialog" aria-labelledby="contactDialogLabel"
        aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            <h3 id="contactDialogLabel">Add contact</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputContactName">Name</label>
                    <div class="controls">
                        <input data-bind="value: contactName" type="text" id="inputContactName" placeholder="Name" autocomplete="name"
                            style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputContactEmail">Email</label>
                    <div class="controls">
                        <input data-bind="value: contactEmail" type="text" id="inputContactEmail" autocomplete="email"
                            placeholder="Email" style="width: 150px;">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputContactPhone">Phone</label>
                    <div class="controls">
                        <input data-bind="value: contactPhone" type="text" id="inputContactPhone" autocomplete="telephone"
                            placeholder="Phone" style="width: 150px;">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button data-bind="click: register" class="btn btn-primary">Register</button>
            <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
        </div>
    </div>

    <script type="text/javascript">

        function RegisterVM() {
            var self = this;
            self.email = ko.observable();
            self.password = ko.observable();
            self.name = ko.observable();

            self.register = function () {
                $('#register').modal('hide');
                serviceVM.register({
                    email: self.email(),
                    password: self.password(),
                    name: self.name()
                });
                self.email("");
                self.password("");
                self.name("");
            }
        }

        function LoginVM() {
            var self = this;
            self.email = ko.observable();
            self.password = ko.observable();

            self.login = function () {
                $('#login').modal('hide');
                serviceVM.login({
                    email: self.email(),
                    password: self.password()
                });
                self.email("");
                self.password("");
            }
        }

        function MessageVM() {
            var self = this;
            self.error = ko.observable();
            self.warning = ko.observable();

            self.showWarning = function (warn) {
                self.warning(warn);
                $('#message').fadeIn(400).delay(5000).fadeOut(400);
            }
        }

        function NavVM() {
            var self = this;
            self.authenticated = ko.observable(false);
            self.showRegister = function (data) {
                $('#register').modal('show');
            }

            self.showLogin = function (data) {
                $('#login').modal('show');
            }

            self.loggedIn = function (bl) {
                self.authenticated(bl);
            }

            self.logout = function () {
                self.authenticated(false);
                serviceVM.logout();
            }
        }

        function ServiceVM() {
            var self = this;
            self.userUri = 'http://localhost:9001/phonebook/api/v1/user';
            self.loginUri = self.userUri + "/login";
            self.serviceUsername = "";
            self.servicePassword = "";
            self.tasks = ko.observableArray();
            
            self.auth = function (xhr) {
                xhr.setRequestHeader("Authorization",
                    "Basic " + btoa(self.serviceUsername + ":" + self.servicePassword));
            }
            
            if(self.serviceUsername == "") {
                self.auth = null;
            }

            self.ajax = function (uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: JSON.stringify(data),
                    beforeSend: self.auth,
                    error: function (err) {
                        console.log("ajax error " + err.status + " " + err.statusText);
                        messageVM.showWarning(err.responseText);
                    }
                };
                return $.ajax(request);
            }

            self.register = function (user) {
                self.ajax(self.userUri, "POST", user).done(function (data) {
                    self.login(user);
                });
            }

            self.logout = function () {
                self.serviceUsername = "";
                self.servicePassword = "";
                $('#phonebook').hide();
                $('#main').show();
            }

            self.login = function (user) {
                self.ajax(self.loginUri, "POST", user).done(function (data) {
                    navVM.loggedIn(true);
                    self.serviceUsername = user.email;
                    self.servicePassword = user.password;
                    $('#main').hide();
                    $('#phonebook').show();
                });
            }
        }

        var serviceVM = new ServiceVM();
        var registerVM = new RegisterVM();
        var navVM = new NavVM();
        var messageVM = new MessageVM();
        var loginVM = new LoginVM();
        ko.applyBindings(serviceVM, $('#main')[0]);
        ko.applyBindings(registerVM, $('#register')[0]);
        ko.applyBindings(navVM, $('#nav')[0]);
        ko.applyBindings(messageVM, $('#message')[0]);
        ko.applyBindings(loginVM, $('#login')[0]);


    </script>
</body>

</html>